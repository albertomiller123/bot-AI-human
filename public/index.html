<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANTIGRAVITY BOT CONTROL</title>
    <!-- Font: VT323 for authentic terminal look -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* DESIGN SPECS: COLOR PALETTE */
        :root {
            --bg-color: #1c1c1c;
            --panel-bg: rgba(30, 30, 30, 0.95);
            --border-dark: #111111;
            --border-light: #505050;
            --text-white: #ffffff;
            --mc-green: #55ff55;
            --mc-red: #ff5555;
            --mc-gold: #ffaa00;
            --mc-aqua: #55ffff;
            --mc-gray: #aaaaaa;
            --btn-normal: #757575;
            --btn-active: #505050;
        }

        /* RESET & TYPOGRAPHY */
        body {
            font-family: 'VT323', monospace;
            background-color: var(--bg-color);
            color: var(--text-white);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            text-shadow: 2px 2px 0px #000000;
            /* MC Shadow */
            font-size: 22px;
        }

        /* 3D PANEL BORDER EFFECT */
        .mc-panel {
            background: var(--panel-bg);
            border: 3px solid;
            border-top-color: var(--border-light);
            border-left-color: var(--border-light);
            border-bottom-color: var(--border-dark);
            border-right-color: var(--border-dark);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* LAYOUT GRID */
        .grid-container {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            /* Left | Main | Right */
            grid-template-rows: 1fr;
            height: 100vh;
            gap: 0;
        }

        /* HEADER */
        header {
            background: #111;
            padding: 5px 15px;
            border-bottom: 2px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            color: var(--mc-gold);
        }

        /* COLUMN STYLES */
        .sidebar-left,
        .sidebar-right {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .main-view {
            padding: 0;
            background: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-left: 3px solid var(--border-dark);
            border-right: 3px solid var(--border-dark);
        }

        /* MC BUTTON */
        .mc-btn {
            background-color: var(--btn-normal);
            border: 2px solid;
            border-top-color: var(--border-light);
            border-left-color: var(--border-light);
            border-bottom-color: var(--border-dark);
            border-right-color: var(--border-dark);
            color: #fff;
            padding: 8px 10px;
            font-family: 'VT323', monospace;
            font-size: 24px;
            text-shadow: 2px 2px 0px #000;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
            text-align: center;
        }

        .mc-btn:active {
            background-color: var(--btn-active);
            border-top-color: var(--border-dark);
            border-left-color: var(--border-dark);
            border-bottom-color: var(--border-light);
            border-right-color: var(--border-light);
            transform: translateY(2px);
        }

        .mc-btn.red {
            background-color: #aa0000;
        }

        .mc-btn.red:hover {
            background-color: #ff0000;
        }

        .mc-btn.green {
            background-color: #008800;
        }

        .mc-btn.green:hover {
            background-color: #00aa00;
        }

        /* INPUTS */
        .mc-input {
            width: 100%;
            background: #000;
            border: 2px solid var(--border-light);
            color: white;
            padding: 5px;
            font-family: 'VT323', monospace;
            font-size: 20px;
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        /* STATUS METRICS */
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .stat-val {
            color: var(--mc-green);
        }

        .stat-label {
            color: var(--mc-gray);
        }

        /* LOGS */
        #chat-stream {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border-dark);
            padding: 5px;
            overflow-y: auto;
            font-size: 18px;
            height: 300px;
        }

        .log-line {
            margin-bottom: 2px;
        }

        .log-user {
            color: var(--mc-gold);
        }

        .log-bot {
            color: var(--mc-aqua);
        }

        .log-sys {
            color: var(--mc-gray);
            font-style: italic;
        }

        /* IFRAME FOR VISION */
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .vision-placeholder {
            color: var(--mc-red);
            font-size: 30px;
            text-align: center;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1c1c1c;
        }

        ::-webkit-scrollbar-thumb {
            background: #505050;
            border: 2px solid #1c1c1c;
        }
    </style>
</head>

<body>

    <div class="grid-container">
        <!-- LEFT PANEL: STATUS & LOGS -->
        <div class="sidebar-left mc-panel">
            <h2 style="text-align: center; color: var(--mc-gold); margin: 5px 0;">STATUS</h2>

            <div style="padding: 10px; background: rgba(0,0,0,0.3); margin-bottom: 10px;">
                <div class="stat-row"><span class="stat-label">STATUS:</span> <span id="st-online"
                        class="stat-val">OFFLINE</span></div>
                <div class="stat-row"><span class="stat-label">HEALTH:</span> <span id="st-health"
                        class="stat-val">--</span></div>
                <div class="stat-row"><span class="stat-label">FOOD:</span> <span id="st-food"
                        class="stat-val">--</span></div>
                <div class="stat-row"><span class="stat-label">POS:</span> <span id="st-pos" class="stat-val"
                        style="color: var(--mc-aqua)">--</span></div>
            </div>

            <h2 style="text-align: center; color: var(--mc-aqua); margin: 5px 0;">TERMINAL</h2>
            <div id="chat-stream">
                <!-- Chat logs go here -->
                <div class="log-line log-sys">> Connecting to Neural Network...</div>
            </div>

            <div style="margin-top: 10px;">
                <input type="text" id="chat-input" class="mc-input" placeholder="Type message..."
                    onkeypress="handleEnter(event)">
                <button class="mc-btn" onclick="sendChat()">SEND >></button>
            </div>
        </div>

        <!-- MAIN WINDOW: VISION -->
        <div class="main-view">
            <!-- Iframe to Port 3008 (Prismarine Viewer) -->
            <!-- We use a script to try ensure it loads or shows fallback -->
            <iframe id="vision-frame" src="http://localhost:3008"
                onerror="this.style.display='none'; document.getElementById('vision-fallback').style.display='block'"></iframe>
            <div id="vision-fallback" class="vision-placeholder" style="display:none; position:absolute;">
                [VISION OFFLINE]<br>
                <small>Check Port 3008</small>
            </div>
        </div>

        <!-- RIGHT PANEL: COMMANDS -->
        <div class="sidebar-right mc-panel">
            <h2 style="text-align: center; color: var(--mc-red); margin: 5px 0;">CONTROL</h2>

            <!-- Quick Actions -->
            <button class="mc-btn red" onclick="sendQuickAction('stop')">ðŸ›‘ EMERGENCY STOP</button>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button class="mc-btn" onclick="sendQuickAction('jump')">JUMP</button>
                <button class="mc-btn" onclick="sendQuickAction('drop_all')">DROP</button>
                <button class="mc-btn" onclick="sendQuickAction('guard_toggle')">GUARD</button>
                <button class="mc-btn" onclick="sendQuickAction('wander')">WANDER</button>
            </div>

            <h2 style="text-align: center; color: var(--mc-gold); margin: 15px 0 5px 0;">AI PLANNER</h2>
            <textarea id="ai-input" class="mc-input" rows="4"
                placeholder="Instruction (e.g., 'Build a tower')..."></textarea>
            <button class="mc-btn green" onclick="sendAICommand()">EXECUTE PLAN >></button>

            <!-- Task Monitor -->
            <div style="margin-top: auto; border-top: 2px solid var(--border-light); padding-top: 10px;">
                <span class="stat-label">CURRENT TASK:</span><br>
                <span id="task-info" style="color: var(--mc-gold)">IDLE</span>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // Check vision stream availability
        const frame = document.getElementById('vision-frame');
        const fallback = document.getElementById('vision-fallback');

        // Simple check: if iframe loads ok (hard to detect cross-origin), assume ok.
        // Real check usually involves fetching from backend. 
        // For now, we trust the browser handling.

        function handleEnter(e) {
            if (e.key === 'Enter') sendChat();
        }

        async function sendQuickAction(action) {
            addLog(`> Executing: ${action.toUpperCase()}`, 'sys');
            try {
                // Compatible with existing /api/command or specific logic
                // Using /api/command for now as bot handles simple commands there too
                // Or /api/action if implemented? Previous code used fetch('/api/action') but noted it needed implementation.
                // Let's stick to /api/command with simple text for now, OR /api/action if it works.
                // Let's assume /api/command handles key words or we use specific endpoint

                await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: action })
                });
            } catch (e) {
                addLog(`ERROR: ${e.message}`, 'sys');
            }
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if (!msg) return;

            addLog(`YOU: ${msg}`, 'user');
            input.value = '';

            try {
                await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg })
                });
            } catch (e) {
                addLog(`ERROR: Connect Failed`, 'sys');
            }
        }

        async function sendAICommand() {
            const input = document.getElementById('ai-input');
            const cmd = input.value;
            if (!cmd) return;

            addLog(`AI: Planning "${cmd}"...`, 'sys');
            input.value = '';

            try {
                const res = await fetch('/api/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: cmd })
                });
                const data = await res.json();
                if (data.success) {
                    addLog(`AI: Plan Generated`, 'bot');
                } else {
                    addLog(`AI: ${data.error}`, 'sys');
                }
            } catch (e) {
                addLog(`ERROR: System Offline`, 'sys');
            }
        }

        function addLog(text, type) {
            const div = document.createElement('div');
            div.className = 'log-line';
            if (type === 'user') {
                div.innerHTML = `<span class="log-user">${text}</span>`;
            } else if (type === 'bot') {
                div.innerHTML = `<span class="log-bot">${text}</span>`;
            } else {
                div.innerHTML = `<span class="log-sys">${text}</span>`;
            }
            const container = document.getElementById('chat-stream');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // POLL STATUS
        setInterval(async () => {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                const online = data.status === 'online';
                const stOnline = document.getElementById('st-online');
                stOnline.innerText = online ? "ONLINE" : "OFFLINE";
                stOnline.style.color = online ? "var(--mc-green)" : "var(--mc-red)";

                if (online) {
                    document.getElementById('st-health').innerText = Math.round(data.health);
                    document.getElementById('st-food').innerText = Math.round(data.food);
                    if (data.position) {
                        const { x, y, z } = data.position;
                        document.getElementById('st-pos').innerText = `${Math.floor(x)}, ${Math.floor(y)}, ${Math.floor(z)}`;
                    }

                    if (data.task) {
                        document.getElementById('task-info').innerText = data.task.toString().toUpperCase();
                    }

                    // Sync chat log? (Optional, implies fetching history)
                }
            } catch (e) {
                // console.log("Status Poll Error");
            }
        }, 1000);

    </script>
</body>

</html>